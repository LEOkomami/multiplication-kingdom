<!doctype html>
<html lang="he" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0b1020">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-512.png">
  <link rel="manifest" href="manifest.json">
  <title>×××œ×›×ª ×”×›×¤×œ - ×”×¨×¤×ª×§×ª ×—×™×•×ª</title>
  <link rel="stylesheet" href="style.css">
  <script src="translations.js"></script>
</head>

<body>
  <div id="mobileBlock">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“±</div>
    <h2 style="margin-bottom: 10px;">×××œ×›×ª ×”×›×¤×œ</h2>
    <p style="font-size: 18px; font-weight: 700; color: var(--muted);">×”××©×—×§ ××•×ª×× ×œ××—×©×‘×™× ×•×œ×˜××‘×œ×˜×™× ×‘×œ×‘×“.</p>
    <p style="font-size: 14px; color: var(--muted); margin-top: 10px;">× × ×œ×¤×ª×•×— ××ª ×”××ª×¨ ×××›×©×™×¨ ×¢× ××¡×š ×’×“×•×œ ×™×•×ª×¨ ×›×“×™
      ×œ×©×—×§.</p>
  </div>
  <header>
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h1 data-t="headerTitle">×××œ×›×ª ×”×›×¤×œ ğŸ¦</h1>
        <div class="sub" data-t="headerSub">×‘×¨×•×›×™× ×”×‘××™× ×œ×××œ×›×”! ×›×‘×©×• ×ª××™×, ××¡×¤×• ×—×™×•×ª × ×“×™×¨×•×ª ×•×©×‘×¨×• ×©×™××™×.</div>
      </div>
      <div class="controls">
        <span class="pill"><span data-t="player">×©×—×§×Ÿ/×™×ª:</span> <b id="activeProfileName">-</b></span>
        <select id="langSelect" class="langSelect" title="Language">
          <option value="he">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</option>
          <option value="en">ğŸ‡ºğŸ‡¸ English</option>
          <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        </select>
        <button class="btn icon" id="toggleSoundBtn" title="×¦×œ×™×œ×™×" type="button">ğŸ”Š</button>
        <button class="btn" id="leaderboardBtn" data-t="leaderboardBtn" type="button">×˜×‘×œ×ª ×”××œ×•×¤×™×</button>
        <button class="btn" id="profilesBtn" data-t="profilesBtn" type="button">×¤×¨×•×¤×™×œ×™×</button>
        <button class="btn danger" id="resetProfileBtn" data-t="resetBtn" type="button">××™×¤×•×¡ ×¤×¨×•×¤×™×œ</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="hd">
        <div class="controls">
          <span class="pill">×›×™×‘×•×©: <b id="progressPct">0%</b></span>
          <span class="pill">×¨×¦×£ × ×›×•×Ÿ: <b id="streak">0</b></span>
        </div>
      </div>

      <div class="hd">
        <div class="select">
          <label class="pill">
            <span data-t="maxNLabel">×œ×•×— ×¢×“:</span>
            <select id="maxN">
              <option value="10" selected>10</option>
              <option value="12">12</option>
            </select>
        </div>
      </div>

      <div class="gridWrap">
        <div id="grid" class="grid" aria-label="Multiplication grid"></div>
      </div>
    </section>

    <aside class="card">
      <div class="bd">
        <div class="gameBox">

          <div class="stats">
            <div class="stat">
              <div class="k" data-t="scorePoints">× ×§×•×“×•×ª</div>
              <div class="v" id="totalPoints">0</div>
            </div>
            <div class="stat">
              <div class="k" data-t="scoreAnimals">×—×™×•×ª</div>
              <div class="v" id="animalsCount">0</div>
            </div>
          </div>

          <div class="panel">
            <div class="qTop">
              <div class="pill">××•×¡×£ ×—×™×•×ª ×”×¤× ×˜×–×™×”</div>
              <button class="btn tiny" id="openKingdomBtn" type="button">×¦×¤×” ×‘×›×œ ×”×××œ×›×”</button>
            </div>
            <div class="collection" id="collection"></div>
          </div>

        </div>
      </div>
    </aside>
  </main>

  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Profiles">
      <div class="mhd">
        <div class="pill">×¤×¨×•×¤×™×œ×™×</div>
        <div class="controls">
          <button class="btn" id="closeModalBtn" type="button">×¡×’×•×¨</button>
        </div>
      </div>
      <div class="mbd">
        <div class="note" style="font-size: 18px; line-height: 1.5; font-weight: 700; color: var(--text);">
          ×œ×›×œ ×¤×¨×•×¤×™×œ ×™×© ×”×ª×§×“××•×ª ×•××•×¡×£ × ×¤×¨×“×™×. ×–×” × ×©××¨ ×¢×œ ×”××—×©×‘ ×”×–×” ×‘×œ×‘×“.
        </div>

        <div style="margin-top:12px;" class="profiles" id="profilesList"></div>

        <div style="margin-top:14px;">
          <div class="mhd">
            <div class="pill" data-t="createProfileTitle">×™×¦×™×¨×ª ×¤×¨×•×¤×™×œ ×—×“×©</div>
          </div>
          <div class="mbd">
            <div class="controls formRow">
              <input type="text" id="newProfileName" class="textInput" placeholder="×©× (×œ×“×•×’××”: × ×•×¢×)"
                data-t-placeholder="namePlace" />
              <select id="newProfileAvatar" title="Avatar">
                <option value="ğŸ¦Š">ğŸ¦Š</option>
                <option value="ğŸ¦">ğŸ¦</option>
                <option value="ğŸ¦„">ğŸ¦„</option>
                <option value="ğŸ¸">ğŸ¸</option>
                <option value="ğŸµ">ğŸµ</option>
                <option value="ğŸ¼">ğŸ¼</option>
                <option value="ğŸ">ğŸ</option>
                <option value="ğŸ¦‹">ğŸ¦‹</option>
              </select>
              <button class="btn primary" id="createProfileBtn" data-t="createBtn" type="button">×¦×•×¨ ×•×›× ×¡
                ×œ×××œ×›×”</button>
            </div>
            <div class="profiles" id="profilesList" style="margin-top:20px;"></div>
          </div>
          <div class="note" style="margin-top:10px;">
            ×˜×™×¤: ××¤×©×¨ ×œ×™×¦×•×¨ ×’× ×¤×¨×•×¤×™×œ ×œ××—×•×ª, ××• ××¦×‘ "××•×¨×—" ×‘×©×‘×™×œ ×—×‘×¨×™×.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="challengeModal" aria-hidden="true">
    <div class="modal" style="width: min(550px, 100%);" role="dialog" aria-modal="true">
      <div class="mhd">
        <div class="pill" id="questTitle">××ª×’×¨ ×§×¡×•×</div>
      </div>
      <div class="mbd" style="text-align:center;">
        <div id="questExpr" class="mathExpr">?</div>
        <div id="questInstruction" class="note"
          style="font-size:17px; margin-bottom:15px; font-weight:800; color:var(--text);">×˜×•×¢×Ÿ ××ª×’×¨...</div>
        <div id="questContainer"
          style="position:relative; width:100%; height:340px; margin:0 auto; background:rgba(0,0,0,.3); border-radius:24px; overflow:hidden; border:2px solid var(--accent); display:flex; align-items:center; justify-content:center;">
          <!-- Content injected via JS -->
        </div>

        <div id="bonusSection"
          style="margin-top:25px; background:rgba(255,209,102,0.15); padding:30px; border-radius:30px; border:4px dashed var(--accent); position:relative; overflow:hidden;">
          <div
            style="margin-bottom:15px; font-weight:1000; font-size:28px; color:var(--accent); text-shadow: 0 0 15px rgba(255,209,102,0.5);"
            data-t="bonusTitle">
            ğŸ’ ×‘×•× ×•×¡: ×™×•×“×¢×™× ××ª ×”×ª×•×¦××”?</div>
          <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
            <input type="number" id="bonusAnswerInput" class="textInput" placeholder="?"
              style="width:160px; height:90px; text-align:center; font-size:48px; border-width:3px; border-color:var(--accent); background:rgba(0,0,0,0.5); border-radius:20px;" />
            <div style="text-align:right;">
              <div style="font-size:22px; font-weight:1000; color:var(--good);" data-t="bonusPoints">3+ × ×§×•×“×•×ª ×‘×•× ×•×¡!
              </div>
              <div class="note" style="font-size:16px; font-weight:800; opacity:0.8;" data-t="bonusNote">××œ× ×œ×¤× ×™ ×¤×ª×¨×•×Ÿ
                ×”××©×™××”</div>
            </div>
          </div>
        </div>

        <button class="btn primary" id="finishChallengeBtn" style="margin-top:20px; display:none;" type="button"
          data-t="continueBtn">×”××©×š
          ×”×œ××”!</button>
      </div>
    </div>
  </div>

  <div class="modalBack" id="kingdomModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Kingdom">
      <div class="mhd">
        <div class="pill" data-t="kingdomTitle">×”×××œ×›×” ×©×œ×™: ×›×œ ×”×—×™×•×ª ×©××¡×¤×ª</div>
        <div class="controls">
          <button class="btn" id="closeKingdomBtn" data-t="closeBtn" type="button">×¡×’×•×¨</button>
        </div>
      </div>
      <div class="mbd">
        <div class="kingdomGrid" id="kingdomGrid"></div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="leaderboardModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Leaderboard">
      <div class="mhd">
        <div class="pill" data-t="leaderboardTitle">×˜×‘×œ×ª ×”××œ×•×¤×™× ğŸ†</div>
        <div class="controls">
          <button class="btn" id="closeLeaderboardBtn" data-t="closeBtn" type="button">×¡×’×•×¨</button>
        </div>
      </div>
      <div class="mbd">
        <div class="note" data-t="leaderboardNote">×›×œ ×”×©×—×§× ×™×/×•×ª ×‘×××œ×›×” ×•×”×”×™×©×’×™× ×©×œ×”×:</div>
        <div id="leaderboardList" style="margin-top:15px; display:grid; gap:10px;"></div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="welcomeModal" aria-hidden="true" style="z-index: 2000;">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Welcome">
      <div class="mhd">
        <div class="pill" data-t="welcomeTitle">×‘×¨×•×›×™× ×”×‘××™× ×œ×××œ×›×ª ×”×›×¤×œ! ğŸ°</div>
        <select id="welcomeLangSelect" class="langSelect" style="padding: 6px 10px; font-size: 12px; width: auto;">
          <option value="he">ğŸ‡®ğŸ‡±</option>
          <option value="en">ğŸ‡ºğŸ‡¸</option>
          <option value="de">ğŸ‡©ğŸ‡ª</option>
        </select>
      </div>
      <div class="mbd" style="text-align: center;">
        <div style="font-size: 20px; margin-bottom: 20px; line-height: 1.6;" data-t="welcomeText">
          ×‘×××œ×›×” ×”×–×•, ×›×œ ×ª×¨×’×™×œ ×›×¤×œ ×”×•× <b>××©×™××” ×§×¡×•××”</b>!<br>
          ×¤×ª×¨×• ×—×™×“×•×ª, ×’×œ×• ×—×™×•×ª × ×“×™×¨×•×ª, ×•×”×¤×›×• ×œ××œ×•×¤×™ ×”×›×¤×œ. ğŸ†
        </div>

        <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 25px;">
          <div class="stat">
            <div class="v">ğŸ”®</div>
            <div class="k" data-t="questSolved">×¤×ª×¨×• ××©×™××•×ª</div>
          </div>
          <div class="stat">
            <div class="v">ğŸ¦</div>
            <div class="k" data-t="questCollect">××¡×¤×• ×—×™×•×ª</div>
          </div>
          <div class="stat">
            <div class="v">â­</div>
            <div class="k" data-t="questScore">×¦×‘×¨×• × ×§×•×“×•×ª</div>
          </div>
        </div>

        <button class="btn primary" id="startGameBtn" style="font-size: 20px; padding: 15px 30px; width: 100%;"
          data-t="startAdv">××ª×—×™×œ×™×
          ×‘×”×¨×¤×ª×§×”! ğŸš€</button>

        <div
          style="margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer;"
          id="dontShowWelcomeRow">
          <div
            style="width: 20px; height: 20px; border: 2px solid var(--muted); border-radius: 4px; display: flex; align-items: center; justify-content: center;"
            id="dontShowCheckbox"></div>
          <div class="tiny" style="font-size: 14px;" data-t="dontShow">××œ ×ª×¦×™×’ ×–××ª ×©×•×‘</div>
        </div>
      </div>
    </div>
  </div>

  <div id="successOverlay">
    <div class="successTitle" data-t="successTitle">â­ ××¢×•×œ×”! â­</div>
    <div class="successExpr mathExpr" id="successOverlayExpr">2 Ã— 2 = 4</div>
    <div class="successPoints" id="successOverlayPoints">+1 × ×§×•×“×•×ª</div>
  </div>

  <footer
    style="text-align:center; padding: 20px 0; color: rgba(255,255,255,0.3); font-weight: 900; letter-spacing: 2px; font-size: 14px;">
    <div></div>A KONAMI APP</div>
    <a href="https://buymeacoffee.com/leokonami" target="_blank"
      style="display:inline-flex; align-items:center; gap:6px; margin-top:8px; text-decoration:none; color:rgba(255,209,102,0.6); font-size:12px; transition:opacity 0.2s;">
      <span style="font-size:16px;">â˜•</span> Buy me a coffee
    </a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    (function () {
      const STORAGE_KEY = "mul_kingdom_v1";

      const els = {
        grid: document.getElementById("grid"),
        qExpr: document.getElementById("qExpr") || {},
        qStory: document.getElementById("qStory") || {},
        targetCell: document.getElementById("targetCell") || {},
        newRoundBtn: document.getElementById("newRoundBtn") || {},
        resetProfileBtn: document.getElementById("resetProfileBtn"),
        streak: document.getElementById("streak"),
        progressPct: document.getElementById("progressPct"),
        totalPoints: document.getElementById("totalPoints"),
        maxN: document.getElementById("maxN"),
        collection: document.getElementById("collection"),
        animalsCount: document.getElementById("animalsCount"),
        bonusAnswerInput: document.getElementById("bonusAnswerInput"),

        activeProfileName: document.getElementById("activeProfileName"),
        profilesBtn: document.getElementById("profilesBtn"),
        modalBack: document.getElementById("modalBack"),
        closeModalBtn: document.getElementById("closeModalBtn"),
        profilesList: document.getElementById("profilesList"),
        newProfileName: document.getElementById("newProfileName"),
        newProfileAvatar: document.getElementById("newProfileAvatar"),
        createProfileBtn: document.getElementById("createProfileBtn"),

        toggleSoundBtn: document.getElementById("toggleSoundBtn"),
        openKingdomBtn: document.getElementById("openKingdomBtn"),
        kingdomModal: document.getElementById("kingdomModal"),
        kingdomGrid: document.getElementById("kingdomGrid"),
        closeKingdomBtn: document.getElementById("closeKingdomBtn"),

        challengeModal: document.getElementById("challengeModal"),
        questTitle: document.getElementById("questTitle"),
        questExpr: document.getElementById("questExpr"),
        questInstruction: document.getElementById("questInstruction"),
        questContainer: document.getElementById("questContainer"),
        finishChallengeBtn: document.getElementById("finishChallengeBtn"),

        leaderboardBtn: document.getElementById("leaderboardBtn"),
        leaderboardModal: document.getElementById("leaderboardModal"),
        leaderboardList: document.getElementById("leaderboardList"),
        closeLeaderboardBtn: document.getElementById("closeLeaderboardBtn"),

        welcomeModal: document.getElementById("welcomeModal"),
        startGameBtn: document.getElementById("startGameBtn"),
        dontShowWelcomeRow: document.getElementById("dontShowWelcomeRow"),
        dontShowCheckbox: document.getElementById("dontShowCheckbox"),

        successOverlay: document.getElementById("successOverlay"),
        successOverlayExpr: document.getElementById("successOverlayExpr"),
        successOverlayPoints: document.getElementById("successOverlayPoints"),
      };
      els.feedback = document.getElementById("feedback") || {};

      const animalPool = [
        { emoji: "ğŸ¦Š", name: "×©×•×¢×œ ×¢×¨×¤×œ", id: "fox" },
        { emoji: "ğŸº", name: "×–××‘ ×™×¨×—", id: "wolf" },
        { emoji: "ğŸ¦", name: "××¨×™×” ×–×”×‘", id: "lion" },
        { emoji: "ğŸ¯", name: "×˜×™×’×¨×™×¡ ×‘×¨×§", id: "tiger" },
        { emoji: "ğŸ»", name: "×“×•×‘ ×™×¢×¨", id: "bear" },
        { emoji: "ğŸ¦‰", name: "×™× ×©×•×£ ×—×›×", id: "owl" },
        { emoji: "ğŸ²", name: "×“×¨×§×•×Ÿ ×§×˜×Ÿ", id: "dragon" },
        { emoji: "ğŸ¦„", name: "×—×“ ×§×¨×Ÿ × ×•×¦×¥", id: "unicorn" },
        { emoji: "ğŸ¬", name: "×“×•×œ×¤×™×Ÿ ×™×", id: "dolphin" },
        { emoji: "ğŸ´", name: "×¡×•×¡ ×¨×•×—", id: "horse" },
        { emoji: "ğŸ¦’", name: "×’×³×™×¨×¤×” ×¢× ×Ÿ", id: "giraffe" },
        { emoji: "ğŸ¼", name: "×¤× ×“×” ×‘××‘×•×§", id: "panda" },
        { emoji: "ğŸ¦“", name: "×–×‘×¨×” ×¤×¡", id: "zebra" },
        { emoji: "ğŸ¦", name: "×“×‘×™×‘×•×Ÿ ×¡×§×¨×Ÿ", id: "raccoon" },
        { emoji: "ğŸ¦”", name: "×§×™×¤×•×“ ×œ×™×œ×”", id: "hedgehog" },
        { emoji: "ğŸ°", name: "××¨× ×‘ ×§×¤×™×¥", id: "rabbit" },
        { emoji: "ğŸ¦¦", name: "×œ×•×˜×¨×” ×©×•×‘×œ", id: "otter" },
        { emoji: "ğŸ¸", name: "×¦×¤×¨×“×¢ ×˜×œ", id: "frog" },
        { emoji: "ğŸ¦œ", name: "×ª×•×›×™ ×¦×‘×¢", id: "parrot" },
        { emoji: "ğŸ¦‹", name: "×¤×¨×¤×¨ ×§×¡×", id: "butterfly" },
      ];

      function getNextAnimalFor(key) {
        const p = getActiveProfile();
        if (!p) return animalPool[0];
        const owned = new Set(p.animals.map(a => a.emoji));
        let next = animalPool.find(a => !owned.has(a.emoji));
        if (!next) next = pick(animalPool);
        return { ...next, key };
      }

      const storyTemplates = [
        "×”×©×¢×¨ ×œ×™×¢×¨ × ×¤×ª×— ×¨×§ ×× ×ª×¤×ª×¨×™ ××ª ×”×§×¡× ×”×–×”.",
        "×—×™×™×ª ×¤× ×˜×–×™×” ××ª×—×‘××ª ×›××Ÿ, ×¦×¨×™×š ××ª ×”×ª×•×¦××” ×›×“×™ ×œ×”×–××™×Ÿ ××•×ª×”.",
        "×”×“×¨×§×•×Ÿ ×”×§×˜×Ÿ ××‘×§×© ×¡×™×¡××”, ×¨×§ ×›×¤×œ ×™×¤×ª×— ××ª ×”×“×œ×ª.",
        "×”×§×•×¡××ª ×©×œ ×”×™×¢×¨ ×©×•××¨×ª ×¢×œ ×ª× ×”×–×”, ×‘×•××™ × ×¢×–×•×¨ ×œ×” ×¢× ×›×¤×œ.",
        "×¨××– ×§×˜×Ÿ: ×ª×•×¦××” × ×›×•× ×”, ×•×ª×¦×˜×¨×¤×™ ×¢×•×“ ×—×™×” ×œ××•×¡×£.",
      ];

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
      function now() { return Date.now(); }

      let audioCtx = null;
      function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }

      function playSound(type) {
        if (!state.soundEnabled) return;
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const nowTime = audioCtx.currentTime;

        if (type === "success") {
          osc.type = "sine";
          osc.frequency.setValueAtTime(523.25, nowTime);
          osc.frequency.exponentialRampToValueAtTime(880, nowTime + 0.1);
          gain.gain.setValueAtTime(0, nowTime);
          gain.gain.linearRampToValueAtTime(0.2, nowTime + 0.05);
          gain.gain.linearRampToValueAtTime(0, nowTime + 0.3);
          osc.start();
          osc.stop(nowTime + 0.3);
        } else if (type === "error") {
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(150, nowTime);
          osc.frequency.linearRampToValueAtTime(50, nowTime + 0.2);
          gain.gain.setValueAtTime(0.2, nowTime);
          gain.gain.linearRampToValueAtTime(0, nowTime + 0.2);
          osc.start();
          osc.stop(nowTime + 0.2);
        }
      }

      const questGames = {
        scratch: {
          titleKey: "scratchTitle",
          instrKey: "scratchInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0; transition:opacity 0.5s; z-index:2; pointer-events:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>
            <canvas style="position:absolute; inset:0; cursor:crosshair; width:100%; height:100%;"></canvas>`;
            const canvas = container.querySelector("canvas");
            const res = container.querySelector("#res");
            const cw = container.clientWidth || 340;
            const ch = container.clientHeight || 340;
            canvas.width = cw;
            canvas.height = ch;

            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#2a3d7a";
            ctx.fillRect(0, 0, cw, ch);
            ctx.globalCompositeOperation = "destination-out";
            let scratched = 0;
            const move = (e) => {
              const rect = canvas.getBoundingClientRect();
              const touch = e.touches ? e.touches[0] : e;
              ctx.beginPath();
              ctx.arc(touch.clientX - rect.left, touch.clientY - rect.top, 35, 0, Math.PI * 2);
              ctx.fill();
              if (++scratched > 100) { res.style.opacity = 1; onWin(); }
            };
            const handleStart = (e) => {
              if (e.type === "touchstart") e.preventDefault();
              canvas.addEventListener(e.type === "touchstart" ? "touchmove" : "mousemove", move);
            };
            const handleEnd = () => {
              canvas.removeEventListener("mousemove", move);
              canvas.removeEventListener("touchmove", move);
            };
            canvas.addEventListener("mousedown", handleStart);
            canvas.addEventListener("touchstart", handleStart);
            window.addEventListener("mouseup", handleEnd);
            window.addEventListener("touchend", handleEnd);
          }
        },
        pop: {
          titleKey: "popTitle",
          instrKey: "popInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let count = 0;
            const makeBubble = () => {
              const b = document.createElement("div");
              b.style.cssText = `position:absolute; width:60px; height:60px; background:rgba(255,255,255,0.2); border:2px solid #fff; border-radius:50%; cursor:pointer; left:${Math.random() * 80}%; top:${Math.random() * 80}%; transition:transform 0.1s; display:flex; align-items:center; justify-content:center; font-size:20px;`;
              b.textContent = "ğŸ«§";
              b.onclick = () => {
                playSound("success");
                b.remove();
                if (++count >= 10) { res.style.display = "flex"; onWin(); }
                else makeBubble();
              };
              container.appendChild(b);
            };
            makeBubble();
          }
        },
        match: {
          titleKey: "matchTitle",
          instrKey: "matchInstr",
          run(container, onWin, animal) {
            const icons = ["ğŸ¦„", "ğŸ‰", "ğŸ§œâ€â™€ï¸", "ğŸ§š", "âœ¨", "ğŸŒŸ", "ğŸ®", "ğŸ”®", "ğŸ’", "ğŸŒˆ", "ğŸ€", "ğŸ­"];
            const target = animal.emoji;
            // Build 12 items: 2 targets + 10 others (filtered if target is in the icons list)
            const others = icons.filter(i => i !== target).slice(0, 10);
            const items = [target, target, ...others];
            items.sort(() => Math.random() - 0.5);
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div><div id="grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:10px;"></div>`;
            const g = container.querySelector("#grid");
            const res = container.querySelector("#res");
            items.forEach(icon => {
              const b = document.createElement("div");
              b.style.cssText = `font-size:40px; cursor:pointer; background:rgba(255,255,255,0.1); border-radius:15px; padding:15px; text-align:center; transition:background 0.3s;`;
              b.textContent = icon;
              b.onclick = () => {
                if (icon === target) { playSound("success"); g.style.display = "none"; res.style.display = "flex"; onWin(); }
                else { b.style.background = "rgba(255,0,0,0.2)"; playSound("error"); }
              };
              g.appendChild(b);
            });
          }
        },
        chase: {
          titleKey: "chaseTitle",
          instrKey: "chaseInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let count = 0;
            const star = document.createElement("div");
            star.style.cssText = `position:absolute; font-size:40px; cursor:pointer; transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width:60px; height:60px; display:flex; align-items:center; justify-content:center; left:40%; top:40%;`;
            star.textContent = "â­";
            const move = () => {
              star.style.left = (Math.random() * 80 + 5) + "%";
              star.style.top = (Math.random() * 80 + 5) + "%";
            };
            star.onclick = () => {
              playSound("success");
              count++;
              if (count >= 6) {
                star.remove();
                res.style.display = "flex";
                onWin();
              } else {
                move();
              }
            };
            container.appendChild(star);
          }
        },
        order: {
          titleKey: "orderTitle",
          instrKey: "orderInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let next = 1;
            [1, 2, 3, 4, 5, 6].sort(() => Math.random() - 0.5).forEach((num, i) => {
              const b = document.createElement("div");
              b.style.cssText = `position:absolute; width:50px; height:50px; background:var(--accent); color:var(--bg); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:20px; cursor:pointer; left:${(i % 3) * 30 + 15}%; top:${Math.floor(i / 3) * 40 + 20}%;`;
              b.textContent = num;
              b.onclick = () => {
                if (num === next) {
                  playSound("success");
                  b.style.opacity = "0.3";
                  b.style.pointerEvents = "none";
                  next++;
                  if (next > 6) { res.style.display = "flex"; onWin(); }
                } else {
                  playSound("error");
                }
              };
              container.appendChild(b);
            });
          }
        },
        glow: {
          titleKey: "glowTitle",
          instrKey: "glowInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let on = 0;
            for (let i = 0; i < 8; i++) {
              const s = document.createElement("div");
              s.style.cssText = `position:absolute; font-size:30px; cursor:pointer; opacity:0.2; left:${(i % 4) * 20 + 15}%; top:${Math.floor(i / 4) * 40 + 30}%; transition:all 0.3s;`;
              s.textContent = "ğŸŒŸ";
              s.onclick = () => {
                if (s.style.opacity === "1") return;
                playSound("success");
                s.style.opacity = "1";
                s.style.transform = "scale(1.3)";
                on++;
                if (on === 8) { res.style.display = "flex"; onWin(); }
              };
              container.appendChild(s);
            }
          }
        },
        stars: {
          titleKey: "starsTitle",
          instrKey: "starsInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none; z-index:5;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let count = 0;
            const spawn = () => {
              if (count >= 8) { res.style.display = "flex"; onWin(); return; }
              const s = document.createElement("div");
              s.style.cssText = `position:absolute; font-size:40px; cursor:pointer; left:${Math.random() * 80 + 5}%; top:${Math.random() * 80 + 5}%; transition:transform 0.2s, opacity 0.5s; opacity:0; transform:scale(0);`;
              s.textContent = "â­";
              container.appendChild(s);
              setTimeout(() => { s.style.opacity = "1"; s.style.transform = "scale(1.2)"; }, 50);
              const timer = setTimeout(() => {
                s.style.opacity = "0";
                s.style.transform = "scale(0)";
                setTimeout(() => { if (s.parentNode) { s.remove(); spawn(); } }, 500);
              }, 1800);
              s.onclick = () => {
                clearTimeout(timer);
                playSound("success");
                count++;
                s.style.transform = "scale(2) rotate(20deg)";
                s.style.opacity = "0";
                setTimeout(() => { s.remove(); spawn(); }, 200);
              };
            };
            spawn();
          }
        },
        crystal: {
          titleKey: "crystalTitle",
          instrKey: "crystalInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            const colors = ["#ff4d6d", "#2bd576", "#ffd166"];
            const order = [0, 1, 2].sort(() => Math.random() - 0.5);
            let userStep = 0;
            let playing = true;
            const btns = [0, 1, 2].map(cIdx => {
              const b = document.createElement("div");
              b.style.cssText = `width:80px; height:80px; background:${colors[cIdx]}; border-radius:15px; cursor:pointer; opacity:0.3; transition:all 0.3s;`;
              return b;
            });
            const wrap = document.createElement("div");
            wrap.style.cssText = "display:flex; gap:20px;";
            btns.forEach(b => wrap.appendChild(b));
            container.appendChild(wrap);
            const showPattern = async () => {
              for (const i of order) {
                await new Promise(r => setTimeout(r, 600));
                btns[i].style.opacity = "1";
                btns[i].style.transform = "scale(1.2)";
                playSound("success");
                await new Promise(r => setTimeout(r, 400));
                btns[i].style.opacity = "0.3";
                btns[i].style.transform = "scale(1)";
              }
              playing = false;
            };
            setTimeout(showPattern, 500);
            btns.forEach((b, i) => {
              b.onclick = () => {
                if (playing) return;
                if (i === order[userStep]) {
                  playSound("success");
                  b.style.opacity = "1";
                  userStep++;
                  if (userStep === order.length) {
                    wrap.style.display = "none";
                    res.style.display = "flex";
                    onWin();
                  }
                } else {
                  playSound("error");
                  userStep = 0;
                  btns.forEach(btn => btn.style.opacity = "0.3");
                }
              };
            });
          }
        },
        firefly: {
          titleKey: "fireflyTitle",
          instrKey: "fireflyInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            let caught = 0;
            for (let i = 0; i < 6; i++) {
              const f = document.createElement("div");
              f.style.cssText = `position:absolute; font-size:24px; cursor:pointer; left:${Math.random() * 80 + 5}%; top:${Math.random() * 80 + 5}%; transition:all 2s ease-in-out; text-shadow: 0 0 10px yellow;`;
              f.textContent = "âœ¨";
              container.appendChild(f);
              const move = () => {
                if (f.textContent === "ğŸª²") return;
                f.style.left = (Math.random() * 80 + 5) + "%";
                f.style.top = (Math.random() * 80 + 5) + "%";
                setTimeout(move, 2000);
              };
              setTimeout(move, 100);
              f.onclick = () => {
                if (f.textContent === "ğŸª²") return;
                f.textContent = "ğŸª²";
                f.style.fontSize = "32px";
                f.style.textShadow = "0 0 20px #fff";
                playSound("success");
                caught++;
                if (caught === 6) {
                  container.querySelectorAll("div:not(#res)").forEach(d => d.remove());
                  res.style.display = "flex";
                  onWin();
                }
              };
            }
          }
        },
        potion: {
          titleKey: "potionTitle",
          instrKey: "potionInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            const cauldron = document.createElement("div");
            cauldron.style.cssText = "font-size:100px; margin-bottom:20px; filter:drop-shadow(0 0 10px #8e44ad);";
            cauldron.textContent = "ğŸ§ª";
            container.appendChild(cauldron);
            const items = ["ğŸ„", "ğŸŒ¿", "ğŸ’"];
            let added = 0;
            const wrap = document.createElement("div");
            wrap.style.cssText = "display:flex; gap:30px;";
            container.appendChild(wrap);
            items.forEach(icon => {
              const it = document.createElement("div");
              it.style.cssText = "font-size:50px; cursor:pointer; transition:all 0.5s;";
              it.textContent = icon;
              it.onclick = () => {
                playSound("success");
                it.style.transform = "translateY(-100px) scale(0)";
                it.style.opacity = "0";
                it.style.pointerEvents = "none";
                added++;
                if (added === 3) {
                  setTimeout(() => {
                    cauldron.style.filter = "drop-shadow(0 0 30px #fff)";
                    cauldron.style.transform = "scale(1.2)";
                    setTimeout(() => {
                      cauldron.style.display = "none";
                      wrap.style.display = "none";
                      res.style.display = "flex";
                      onWin();
                    }, 500);
                  }, 500);
                }
              };
              wrap.appendChild(it);
            });
          }
        },
        leaf: {
          titleKey: "leafTitle",
          instrKey: "leafInstr",
          run(container, onWin, animal) {
            container.innerHTML = `<div id="res" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;">
              <div style="font-size:80px;">${animal.emoji}</div>
              <div style="font-size:24px; font-weight:1000;">${getAnimalName(animal)}</div>
            </div>`;
            const res = container.querySelector("#res");
            const leafIcons = ["ğŸ‚", "ğŸ", "ğŸƒ", "ğŸŒ¿"];
            let cleared = 0;
            for (let i = 0; i < 10; i++) {
              const l = document.createElement("div");
              l.style.cssText = `position:absolute; font-size:60px; cursor:pointer; left:${Math.random() * 70 + 10}%; top:${Math.random() * 70 + 10}%; transition:all 0.6s; transform:rotate(${Math.random() * 360}deg);`;
              l.textContent = pick(leafIcons);
              container.appendChild(l);
              l.onclick = () => {
                playSound("success");
                l.style.transform = `translate(${Math.random() * 400 - 200}px, -300px) rotate(360deg)`;
                l.style.opacity = "0";
                cleared++;
                if (cleared === 10) {
                  res.style.display = "flex";
                  onWin();
                }
              };
            }
          }
        }
      };

      function startQuest(a, b) {
        const key = cellKey(a, b);
        const animal = getNextAnimalFor(key);
        const types = Object.keys(questGames);
        const game = questGames[pick(types)];

        els.questTitle.textContent = t(game.titleKey);
        els.questExpr.textContent = `${a} Ã— ${b}`;
        els.questInstruction.textContent = t(game.instrKey);
        els.questContainer.innerHTML = "";
        els.bonusAnswerInput.value = "";
        els.finishChallengeBtn.style.display = "none";
        els.challengeModal.style.display = "flex";

        game.run(els.questContainer, () => {
          setTimeout(() => {
            const typed = Number(els.bonusAnswerInput.value.trim());
            const isCorrect = !Number.isNaN(typed) && typed === (a * b);

            showSuccessOverlay(a, b, isCorrect ? 3 : 1);

            setTimeout(() => {
              els.challengeModal.style.display = "none";
              markDone(a, b, animal, isCorrect);
              save();
              newRound();
            }, 2000);
          }, 1000);
        }, animal);
      }

      function showSuccessOverlay(a, b, points) {
        els.successOverlayExpr.textContent = `${a} Ã— ${b} = ${a * b}`;
        els.successOverlayPoints.textContent = t("successPoints", { n: points });
        els.successOverlay.style.display = "flex";
        triggerConfetti();
        setTimeout(() => {
          els.successOverlay.style.display = "none";
        }, 2000);
      }

      function triggerConfetti() {
        if (typeof confetti === "function") {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ["#2bd576", "#ffd166", "#e8ecff"]
          });
        }
      }

      const state = {
        activeProfileId: null,
        profiles: {},

        mode: "quest",
        maxN: 10,
        soundEnabled: true,
        lang: "he",

        current: null
      };

      function t(key, params = {}) {
        const lang = state.lang || "he";
        let str = (translations[lang] && translations[lang][key]) || key;
        for (const k in params) {
          str = str.replace(`{${k}}`, params[k]);
        }
        return str;
      }

      function getAnimalName(animal) {
        if (!animal) return "";
        if (animal.id) return t("animal_" + animal.id);
        return animal.name; // Fallback for old data or missing translations
      }

      function setLanguage(lang) {
        if (!translations[lang]) return;
        state.lang = lang;
        save();

        // Update Direction
        document.documentElement.lang = lang;
        document.documentElement.dir = translations[lang].dir;

        // Update Text
        document.querySelectorAll("[data-t]").forEach(el => {
          const key = el.getAttribute("data-t");
          if (translations[lang][key]) el.innerHTML = translations[lang][key];
        });

        // Update Placeholders
        document.querySelectorAll("[data-t-placeholder]").forEach(el => {
          const key = el.getAttribute("data-t-placeholder");
          if (translations[lang][key]) el.placeholder = translations[lang][key];
        });

        // Sync Dropdowns
        if (els.langSelect) els.langSelect.value = lang;
        if (els.welcomeLangSelect) els.welcomeLangSelect.value = lang;

        updateUI();
      }

      function toggleLanguage() {
        const current = state.lang || "he";
        const next = current === "he" ? "en" : (current === "en" ? "de" : "he");
        setLanguage(next);
      }

      function wire() {
        els.resetProfileBtn.addEventListener("click", resetActiveProfile);

        els.maxN.addEventListener("change", setMaxN);

        els.profilesBtn.addEventListener("click", openProfilesModal);
        els.closeModalBtn.addEventListener("click", closeProfilesModal);
        els.modalBack.addEventListener("click", (e) => {
          if (e.target === els.modalBack) closeProfilesModal();
        });

        els.toggleSoundBtn.addEventListener("click", toggleSound);
        els.openKingdomBtn.addEventListener("click", openKingdomModal);
        els.closeKingdomBtn.addEventListener("click", closeKingdomModal);
        els.kingdomModal.addEventListener("click", (e) => {
          if (e.target === els.kingdomModal) closeKingdomModal();
        });

        els.leaderboardBtn.addEventListener("click", openLeaderboard);
        els.closeLeaderboardBtn.addEventListener("click", closeLeaderboard);
        els.leaderboardModal.addEventListener("click", (e) => {
          if (e.target === els.leaderboardModal) closeLeaderboard();
        });

        els.createProfileBtn.addEventListener("click", createProfile);
        els.newProfileName.addEventListener("keydown", (e) => {
          if (e.key === "Enter") createProfile();
        });

        // Welcome Modal Wiring
        els.startGameBtn.addEventListener("click", () => {
          initAudio();
          closeWelcome();
        });
        els.dontShowWelcomeRow.addEventListener("click", toggleDontShowWelcome);

        // Language Dropdowns
        els.langSelect = document.getElementById("langSelect");
        els.welcomeLangSelect = document.getElementById("welcomeLangSelect");

        const onLangChange = (e) => setLanguage(e.target.value);
        if (els.langSelect) els.langSelect.addEventListener("change", onLangChange);
        if (els.welcomeLangSelect) els.welcomeLangSelect.addEventListener("change", onLangChange);
      }

      function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

      function defaultProfile(name, avatar) {
        return {
          id: "p_" + Math.random().toString(16).slice(2) + "_" + now(),
          name: (name || "××•×¨×—/×ª").trim().slice(0, 20),
          avatar: avatar || "ğŸ¦Š",
          createdAt: now(),
          settings: {
            maxN: 10,
          },
          stats: {
            correct: 0,
            wrong: 0,
            streak: 0,
            points: 0,
          },
          done: {},
          animals: []
        };
      }

      function getActiveProfile() {
        if (!state.activeProfileId) return null;
        return state.profiles[state.activeProfileId] || null;
      }

      function save() {
        const toSave = {
          activeProfileId: state.activeProfileId,
          profiles: state.profiles,
          soundEnabled: state.soundEnabled,
          lang: state.lang
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const saved = JSON.parse(raw);
          if (saved && typeof saved === "object") {
            state.activeProfileId = saved.activeProfileId || null;
            state.profiles = saved.profiles && typeof saved.profiles === "object" ? saved.profiles : {};
            if (typeof saved.soundEnabled === "boolean") {
              state.soundEnabled = saved.soundEnabled;
            }
            if (saved.lang) state.lang = saved.lang;
          }
        } catch (e) { }
      }

      function ensureAtLeastOneProfile() {
        if (Object.keys(state.profiles).length > 0) return;

        const p = defaultProfile(t('player') + " 1", "ğŸ¦Š");
        state.profiles[p.id] = p;
        state.activeProfileId = p.id;
        save();
      }

      function applyProfileSettingsToGlobal() {
        const p = getActiveProfile();
        if (!p) return;
        state.maxN = clamp(Number(p.settings.maxN || 10), 2, 12);
        els.maxN.value = String(state.maxN);
      }

      function updateProfileSettingsFromGlobal() {
        const p = getActiveProfile();
        if (!p) return;
        p.settings.maxN = state.maxN;
        save();
      }

      function cellKey(a, b) { return a + "," + b; }

      function totalCells() {
        return state.maxN * state.maxN;
      }

      function doneCellsCount() {
        const p = getActiveProfile();
        if (!p) return 0;
        return Object.keys(p.done).length;
      }

      function progressPercent() {
        const pct = (doneCellsCount() / totalCells()) * 100;
        return Math.round(pct);
      }

      function buildGrid() {
        const p = getActiveProfile();
        const n = state.maxN;
        els.grid.style.gridTemplateColumns = `64px repeat(${n}, 1fr)`;
        els.grid.innerHTML = "";

        const make = (text, cls) => {
          const d = document.createElement("div");
          d.className = "cell " + (cls || "");
          d.textContent = text;
          return d;
        };

        els.grid.appendChild(make("Ã—", "corner"));
        for (let j = 1; j <= n; j++) {
          els.grid.appendChild(make(String(j), "head"));
        }

        for (let i = 1; i <= n; i++) {
          els.grid.appendChild(make(String(i), "head"));
          for (let j = 1; j <= n; j++) {
            const key = cellKey(i, j);
            const d = make("", "work");
            d.dataset.a = String(i);
            d.dataset.b = String(j);
            d.dataset.key = key;

            const isDone = p ? !!p.done[key] : false;
            if (isDone) d.classList.add("done");

            const val = i * j;

            if (isDone) {
              d.innerHTML = `<div class="mini">${val}</div><div class="submini">${i}Ã—${j}</div>`;
            } else {
              d.innerHTML = ``;
              d.onclick = () => {
                if (isDone) return;
                startQuest(i, j);
              };
            }

            d.title = `${i}Ã—${j}`;
            d.addEventListener("click", () => {
              setCurrent(i, j, true);
            });

            els.grid.appendChild(d);
          }
        }

        highlightCurrentCell();
      }

      function highlightCurrentCell() {
        const cells = els.grid.querySelectorAll(".cell.work");
        cells.forEach(c => c.classList.remove("hi"));
        if (!state.current) return;
        const sel = els.grid.querySelector(`.cell.work[data-key="${state.current.key}"]`);
        if (sel) sel.classList.add("hi");
      }

      function pickNextCell() {
        const p = getActiveProfile();
        if (!p) return null;

        const n = state.maxN;
        const candidates = [];
        for (let a = 1; a <= n; a++) {
          for (let b = 1; b <= n; b++) {
            const key = cellKey(a, b);
            if (p.done[key]) continue;
            candidates.push({ a, b, key });
          }
        }

        if (candidates.length === 0) return null;

        const idx = Math.floor(Math.random() * candidates.length);
        return candidates[idx];
      }

      function setFeedback(text, type) {
        els.feedback.classList.remove("good", "bad");
        if (type === "good") els.feedback.classList.add("good");
        if (type === "bad") els.feedback.classList.add("bad");
        els.feedback.textContent = text;
      }

      function simpleHint(a, b, guess) {
        const ans = a * b;
        const max = Math.max(a, b);

        if (max === 10) return "×¨××–: ×›×¤×œ ×‘-10 ×–×” ×œ×”×•×¡×™×£ 0.";
        if (max === 5) return "×¨××–: ×›×¤×œ ×‘-5 ×ª××™×“ × ×’××¨ ×‘-0 ××• 5.";
        if (max === 9) return "×¨××–: ×›×¤×œ ×‘-9, ××¤×©×¨ ×œ×—×©×•×‘ 10Ã—X ×•××– ×œ×”×•×¨×™×“ X.";
        if (max === 8) return "×¨××–: ×›×¤×œ ×‘-8, ××¤×©×¨ ×œ×¢×©×•×ª ×›×¤×•×œ 2 ×©×œ×•×© ×¤×¢××™×.";
        if (max === 4) return "×¨××–: ×›×¤×œ ×‘-4, ××¤×©×¨ ×›×¤×•×œ 2 ×¤×¢××™×™×.";
        if (max === 2) return "×¨××–: ×›×¤×œ ×‘-2 ×–×” ×œ×”×•×¡×™×£ ××ª ×”××¡×¤×¨ ×œ×¢×¦××•.";

        if (typeof guess === "number" && !Number.isNaN(guess)) {
          if (guess < ans) return "×¨××–: ×™×¦× ×œ×š × ××•×š ××“×™.";
          if (guess > ans) return "×¨××–: ×™×¦× ×œ×š ×’×‘×•×” ××“×™.";
        }
        return "×¨××–: ××¤×©×¨ ×œ×¤×¨×§ ×œ×›×¤×œ ×©××ª ×›×‘×¨ ×™×•×“×¢×ª, ×œ××©×œ XÃ—6 ×–×” XÃ—5 ×•×¢×•×“ X.";
      }

      function setStory() {
        const p = getActiveProfile();
        if (!p || !state.current) return;
        const { a, b } = state.current;
        const base = pick(storyTemplates);
        const extra = `(${a}Ã—${b})`;
        els.qStory.textContent = base + " " + extra;
      }

      function awardAnimalForCell(animal) {
        const p = getActiveProfile();
        if (!p) return;
        p.animals.push(animal);
      }

      function renderCollection() {
        const p = getActiveProfile();
        els.collection.innerHTML = "";
        if (!p) return;

        const list = p.animals.slice(-8).reverse();
        if (list.length === 0) {
          const d = document.createElement("div");
          d.className = "note";
          d.textContent = t('noAnimals');
          els.collection.appendChild(d);
          return;
        }

        for (const a of list) {
          const b = document.createElement("div");
          b.className = "badge";
          b.innerHTML = `<div style="font-size:18px;">${a.emoji}</div><div>${getAnimalName(a)}</div>`;
          els.collection.appendChild(b);
        }
      }

      function updateUI() {
        const p = getActiveProfile();

        els.activeProfileName.textContent = p ? (p.avatar + " " + p.name) : "-";
        els.progressPct.textContent = progressPercent() + "%";
        els.streak.textContent = p ? String(p.stats.streak) : "0";
        els.totalPoints.textContent = p ? String(p.stats.points || 0) : "0";
        els.animalsCount.textContent = p ? String(p.animals.length) : "0";

        els.maxN.value = String(state.maxN);
        els.toggleSoundBtn.textContent = state.soundEnabled ? "ğŸ”Š" : "ğŸ”‡";

        renderCollection();
      }

      function setCurrent(a, b, manual) {
        const key = cellKey(a, b);
        const ans = a * b;
        state.current = { a, b, ans, key };

        els.qExpr.textContent = `${a} Ã— ${b} = ?`;

        setStory();
        setFeedback(manual ? t('feedbackManual') : t('feedbackAuto'), "neutral");

        highlightCurrentCell();
      }


      function newRound() {
        const p = getActiveProfile();
        if (!p) {
          setFeedback(t('feedbackSelect'), "neutral");
          return;
        }

        const next = pickNextCell();
        if (!next) {
          state.current = null;
          els.qExpr.textContent = "ğŸ‰";
          setFeedback(t('feedbackDone'), "good");
          highlightCurrentCell();
          updateUI();
          save();
          return;
        }

        setCurrent(next.a, next.b, false);
        updateUI();
        save();
      }

      function markDone(a, b, animal, bonus = false) {
        const p = getActiveProfile();
        if (!p) return;

        const key = cellKey(a, b);
        if (p.done[key]) return;

        p.done[key] = true;
        awardAnimalForCell(animal);
        p.stats.correct += 1;
        p.stats.streak += 1;

        if (!p.stats.points) p.stats.points = 0;
        p.stats.points += (bonus ? 3 : 1);

        buildGrid();
        updateUI();
      }

      function submit() {
        // Disabled since we use quests now
        return;
      }

      function skip() {
        newRound();
      }


      function setMaxN() {
        const p = getActiveProfile();
        const v = clamp(Number(els.maxN.value), 2, 12);
        state.maxN = v;

        if (p) {
          const newDone = {};
          const newAnimals = [];

          for (const key of Object.keys(p.done)) {
            const [a, b] = key.split(",").map(Number);
            if (a <= v && b <= v) newDone[key] = true;
          }

          const allowedKeys = new Set(Object.keys(newDone));
          for (const an of p.animals) {
            if (allowedKeys.has(an.key)) newAnimals.push(an);
          }

          p.done = newDone;
          p.animals = newAnimals;
        }

        updateProfileSettingsFromGlobal();
        buildGrid();
        updateUI();
        newRound();
      }



      function resetActiveProfile() {
        const p = getActiveProfile();
        if (!p) return;
        const ok = confirm(t('confirmReset'));
        if (!ok) return;

        p.done = {};
        p.animals = [];
        p.stats = { correct: 0, wrong: 0, streak: 0, points: 0 };

        save();
        buildGrid();
        updateUI();
        setFeedback(t('feedbackReset'), "neutral");
        newRound();
      }

      function openProfilesModal() {
        els.modalBack.style.display = "flex";
        els.modalBack.setAttribute("aria-hidden", "false");
        renderProfilesModal();
      }

      function closeProfilesModal() {
        els.modalBack.style.display = "none";
        els.modalBack.setAttribute("aria-hidden", "true");
      }

      function renderProfilesModal() {
        els.profilesList.innerHTML = "";

        const ids = Object.keys(state.profiles).sort((a, b) => {
          return (state.profiles[b].createdAt || 0) - (state.profiles[a].createdAt || 0);
        });

        for (const id of ids) {
          const p = state.profiles[id];
          const doneCount = Object.keys(p.done || {}).length;
          const denom = ((p.settings?.maxN || 10) ** 2);
          const pct = denom ? Math.round((doneCount / denom) * 100) : 0;

          const card = document.createElement("div");
          card.className = "profileCard";
          card.innerHTML = `
            <div class="pLeft">
              <div class="avatar">${p.avatar || "ğŸ¦Š"}</div>
              <div>
                <div class="pName">${escapeHtml(p.name || t('player'))}</div>
                <div class="pMeta">${pct}% , ${p.stats?.points || 0} ${t('scorePoints')}, ${p.animals?.length || 0} ${t('scoreAnimals')}</div>
              </div>
            </div>
            <div class="pActions">
              <button class="btn" data-action="select" data-id="${id}" type="button">${t('select')}</button>
              <button class="btn danger" data-action="delete" data-id="${id}" type="button">${t('delete')}</button>
            </div>
          `;
          els.profilesList.appendChild(card);
        }

        els.profilesList.querySelectorAll("button[data-action]").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const action = e.currentTarget.dataset.action;
            const id = e.currentTarget.dataset.id;

            if (action === "select") {
              state.activeProfileId = id;
              applyProfileSettingsToGlobal();
              save();
              closeProfilesModal();
              buildGrid();
              updateUI();
              setFeedback(t('feedbackWelcome') + (getActiveProfile()?.name || ""), "neutral");
              newRound();
            }

            if (action === "delete") {
              const p = state.profiles[id];
              if (!p) return;
              const ok = confirm(t('confirmDelete', { name: p.name }));
              if (!ok) return;

              delete state.profiles[id];
              if (state.activeProfileId === id) {
                state.activeProfileId = Object.keys(state.profiles)[0] || null;
              }
              ensureAtLeastOneProfile();
              applyProfileSettingsToGlobal();
              save();
              renderProfilesModal();
              buildGrid();
              updateUI();
              newRound();
            }
          });
        });
      }

      function createProfile() {
        const name = (els.newProfileName.value || "").trim();
        const avatar = els.newProfileAvatar.value || "ğŸ¦Š";

        if (!name) {
          alert("× × ×œ×›×ª×•×‘ ×©× ×œ×¤×¨×•×¤×™×œ.");
          return;
        }

        const p = defaultProfile(name, avatar);
        state.profiles[p.id] = p;
        state.activeProfileId = p.id;

        els.newProfileName.value = "";
        save();

        applyProfileSettingsToGlobal();
        renderProfilesModal();
        closeProfilesModal();

        buildGrid();
        updateUI();
        setFeedback("×¤×¨×•×¤×™×œ ×—×“×© × ×•×¦×¨. ××ª×—×™×œ×™× ××¡×¢!", "neutral");
        newRound();
      }

      function escapeHtml(s) {
        return String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }

      function toggleSound() {
        state.soundEnabled = !state.soundEnabled;
        updateUI();
        save();
      }

      function openKingdomModal() {
        initAudio(); // Unlock audio on user interaction
        els.kingdomModal.style.display = "flex";
        els.kingdomModal.setAttribute("aria-hidden", "false");
        renderKingdomModal();
      }

      function closeKingdomModal() {
        els.kingdomModal.style.display = "none";
        els.kingdomModal.setAttribute("aria-hidden", "true");
      }

      function renderKingdomModal() {
        const p = getActiveProfile();
        els.kingdomGrid.innerHTML = "";
        if (!p) return;

        if (p.animals.length === 0) {
          els.kingdomGrid.innerHTML = "<div class='note'>×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ×—×™×•×ª ×‘×××œ×›×”. ×›×‘×©×™ ×ª××™× ×›×“×™ ×œ××¡×•×£ ××•×ª×Ÿ!</div>";
          return;
        }

        for (const a of p.animals) {
          const d = document.createElement("div");
          d.className = "kCell";
          d.innerHTML = `
            <div class="kEmoji">${a.emoji}</div>
            <div class="kName">${getAnimalName(a)}</div>
            <div class="kFact">${a.key.replace(",", " Ã— ")}</div>
          `;
          els.kingdomGrid.appendChild(d);
        }
      }

      let dontShowWelcomeState = false;

      function showWelcome() {
        const skip = localStorage.getItem(STORAGE_KEY + "_skipWelcome");
        if (skip === "true") {
          openProfilesModal();
          return;
        }
        els.welcomeModal.style.display = "flex";
        els.welcomeModal.setAttribute("aria-hidden", "false");
      }

      function closeWelcome() {
        els.welcomeModal.style.display = "none";
        els.welcomeModal.setAttribute("aria-hidden", "true");
        if (dontShowWelcomeState) {
          localStorage.setItem(STORAGE_KEY + "_skipWelcome", "true");
        }
        openProfilesModal();
      }

      function toggleDontShowWelcome() {
        dontShowWelcomeState = !dontShowWelcomeState;
        if (dontShowWelcomeState) {
          els.dontShowCheckbox.style.background = "var(--good)";
          els.dontShowCheckbox.innerText = "âœ“";
        } else {
          els.dontShowCheckbox.style.background = "transparent";
          els.dontShowCheckbox.innerText = "";
        }
      }


      function openLeaderboard() {
        els.leaderboardModal.style.display = "flex";
        renderLeaderboard();
      }

      function closeLeaderboard() {
        els.leaderboardModal.style.display = "none";
      }

      function renderLeaderboard() {
        const sorted = Object.values(state.profiles).sort((a, b) => (b.stats.points || 0) - (a.stats.points || 0));
        els.leaderboardList.innerHTML = "";
        sorted.forEach((p, i) => {
          const d = document.createElement("div");
          d.className = "profileCard";
          d.style.cursor = "default";
          d.innerHTML = `
            <div class="pLeft">
              <div style="font-size:20px; font-weight:900; width:30px; color:var(--accent); text-align:center;">${i + 1}</div>
              <div class="avatar">${p.avatar}</div>
              <div>
                <div class="pName">${p.name}</div>
                <div class="pMeta">${p.animals.length} ×—×™×•×ª | ${Object.keys(p.done).length} ×ª××™×</div>
              </div>
            </div>
            <div style="font-size:22px; font-weight:1000; color:var(--good);">${p.stats.points || 0} × ×§×³</div>
          `;
          els.leaderboardList.appendChild(d);
        });
      }

      function init() {
        load();
        ensureAtLeastOneProfile();

        els.profilesCount = document.getElementById("profilesCount");

        if (!state.activeProfileId || !state.profiles[state.activeProfileId]) {
          state.activeProfileId = Object.keys(state.profiles)[0] || null;
        }

        applyProfileSettingsToGlobal();
        wire();

        // Init Language
        setLanguage(state.lang || "he");

        buildGrid();
        updateUI();

        showWelcome();
      }

      init();

      // PWA Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Error:', err));
        });
      }
    })();
  </script>
</body>

</html>